from typing import Dict, List, Set
import logging

logger = logging.getLogger(__name__)

SERVICE_RECOMMENDATIONS = {
    "web_application": ["lambda", "dynamodb", "s3", "api-gateway", "cloudfront"],
    "ecommerce": ["lambda", "dynamodb", "s3", "cognito", "api-gateway", "ses"],
    "marketplace": ["cognito", "dynamodb", "lambda", "s3", "ses", "api-gateway"],
    "social": ["cognito", "dynamodb", "lambda", "s3", "api-gateway", "cloudfront"],
    "mobile_backend": ["lambda", "dynamodb", "cognito", "api-gateway", "s3"],
    "api": ["lambda", "api-gateway", "dynamodb"],
}

FEATURE_SERVICES = {
    "authentication": ["cognito"],
    "real_time": ["appsync"],
    "file_storage": ["s3"],
    "email": ["ses"],
}

def recommend_services(classification: Dict, estimated_users: int) -> List[str]:
    primary = classification["primary"]
    features = classification.get("features", [])
    
    logger.info(f"Recommending for: {primary}")
    
    services: Set[str] = set()
    
    if primary in SERVICE_RECOMMENDATIONS:
        services.update(SERVICE_RECOMMENDATIONS[primary])
    
    for feature in features:
        if feature in FEATURE_SERVICES:
            services.update(FEATURE_SERVICES[feature])
    
    if estimated_users > 10000:
        services.add("cloudfront")
    
    result = list(services)
    logger.info(f"Recommended {len(result)} services")
    
    return result
